# Cirrus Ping Authentication Module
> Express middleware to enable Lilly SSO

## Table of Contents
* [Introduction](#introduction)
* [Prerequisites](#prerequisites)
* [Installation](#installation)
* [Required Environment Variables](#required-environment-variables)
* [Optional Environment Variables](#optional-environment-variables)
* [Usage](#usage)
* [Endpoints](#endpoints)
* [Contributing](#contributing)
* [Support](#support)
* [Setting Express up for HTTPS](#setting-express-up-for-https)
* [Migrating to Version 2](#migrating-to-version-2)

## Introduction
This module aims to provide Lilly SSO for any express.js application


## Prerequisites
### Express.js
You will need to be using Express as your web framework. This module provides middleware for express, and thus will not work for other node web frameworks.

### .npmrc
To install this module, you need access to the gemfury repository. To get access to this, you need a `.npmrc` file in the root of your project's directory. The file should look like this:
```ini
registry = https://elilillyco.jfrog.io/elilillyco/api/npm/Lilly-NPM/
_auth = YXJ0aWZhY3RvcnlAbGlzdHMubGlsbHkuY29tOkFLQ3A1YkIzY3hrdkVGRmlYQUtSU2lQZjFyV0dKV0JIZDllcHoxcEtDSlk4WWNjcDhyb2J6dm52OXV0VjhYNXN3TGFrUlY1d1A=
always-auth = true
email = artifactory@lists.lilly.com
```

## Installation
`npm install cirrus-ping-auth-module` or `yarn add cirrus-ping-auth-module`

It's recommended that you use this module via the hybrid module, found [here.](https://github.com/EliLillyCo/CIRR_AUTH_MODULE)

Please ensure that when developing with the Authentication Module that you're using HTTPS - this is enabled by default on Heroku.

## Environment Variables

| Environment Variable       | Required? | Default Value                       |
| -------------------------- | --------- | ----------------------------------- |
| `OPENID_CLIENT_ID`         | **Yes**   | None. See **<sup>1</sup>.**         |
| `AUTH_ENABLED`             | No        | `false`                             |
| `ENABLE_AUTH_LOGGING`      | No        | `false`                             |
| `OPENID_ISSUER`            | No        | `https://federate-qa.xh1.lilly.com` |
| `OPENID_CALLBACK_ENDPOINT` | No        | `/auth/ping/callback`               |
| `USERID_ENDPOINT`          | No        | `/auth/userid`                      |
| `LOGOUT_ENDPOINT`          | No        | `/logout`                           |
| `AFTER_LOGOUT_URL`         | No        | `/`                                 |

1. **OPENID_CLIENT_ID**: This is the client-id that auth will use to verify. Go [here](https://cirr-heroku-auth-standards.herokuapp.com/) and select the client ID that is in the same group that matches your application name.

NOTE:  Make sure that the name of your Heroku application matches the [APP_URL_NAMING_STANDARD](https://cirr-heroku-auth-standards.herokuapp.com/) listed for the client ID that you are using. **If you're testing locally, your app MUST be running on port 5000!**

   - If you've set this incorrectly, you will get an `invalid uri-redirect` message

## Usage

```js
const auth = require('cirrus-ping-auth-module');
const express = require('express');
const app = express();

auth.authenticate(app);

/** other express middleware goes here **/
...
/* */

// if you want to access routes without authenticating (webhooks, files for a web worker)
auth.ignore('/api/contentful/hook', '/public/bundle.js');

app.listen(5000, () => console.log('Listening on port 5000'));
```

## Endpoints
* GET /auth/userid (configured in .env as USERID_ENDPOINT)
  * Returns a JSON payload:
```json
{
  "userid": "C212345",
  "auth_set": true,
  "user_authed": true,
}
```

To get data from this endpoint, you can use the following code snippet:
```js
// NOT supported by IE. Use the fetch polyfill - https://github.com/github/fetch
const { userid } = await fetch('/auth/userid').then(resp => resp.json());

// supported by older browsers
// not recommended for use
var userid;
var xhr = new XMLHttpRequest();
xhr.open("GET", "/auth/userid");
xhr.onload = function() {
  userid = JSON.parse(this.responseText);
};
xhr.send();
```


* GET /logout
  * Clears auth cookies and resets the session.

## Contributing

1. Clone this repository:

```bash
git clone https://github.com/EliLillyCo/CIRR_PING_AUTH_MODULE.git
```

2. Create a new branch with a descriptive name matching the issue:

```bash
git checkout master
git checkout -b feature/123-issue-description-here
```

3. Create a unit test that fails without the new functionality.

4. Make necessary code changes.

5. Run linting scripts:

```bash
npm run lint
```

6. Run the unit tests:

```bash
npm test
```

7. Update the version number in `package.json` and `package-lock.json` and update the `CHANGELOG.md` file with your changes. This project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html) so keep that in mind when assigning your version number.

8. Push branch to GitHub and open a pull request.

9. Wait for continuous integration tests to pass (will appear as a comment in the pull request).

10. Wait for feedback.

## Support
Lodge an issue on the [issue tracker](https://github.com/EliLillyCo/CIRR_PING_AUTH_MODULE/issues?q=is%3Aissue+is%3Aopen+sort%3Aupdated-desc).

Contact [Drew Hodson](mailto:hodson_drew@network.lilly.com) via Email or Slack.

## Setting Express up for HTTPS
Because you will not be able to develop use auth without HTTPS, this is a quickstart guide to getting HTTPS on a local express setup.

**Note**: Disabling auth will still add the userid endpoint. You may be able to skip this step.
1. Sign some certificates:
```zsh
openssl genrsa -out server-key.pem 1024
openssl req -new -key server-key.pem -out server-csr.pem
openssl x509 -req -in server-csr.pem -signkey server-key.pem -out server-cert.pem
```

2. Pull HTTPS in to your Express app
```javascript
/**
 * Pull in main requirements
 */
const express = require('express');
const https = require('https');
const http = require('http');
const fs = require('fs');
const app = express();

/**
 * Load keys from local files
 */

const key = fs.readFileSync('server-key.pem');
const cert = fs.readFileSync('server-cert.pem');
const options = { key, cert };
app.set('port', process.env.PORT || 5000);

let server;

/**
 * If we're developing locally, use https
 * If we're not, we're on heroku which we can use HTTPS for.
 */
if (process.env.NODE_ENV === 'local') {
  server = https.createServer(options, app);
} else {
  server = http.createServer(app);
}   

// listen and let us know when we're good to go!
server.listen(process.env.PORT);
server.on('listening', () => console.log(`Server listening on localhost:${process.env.PORT}`));
```

## Migrating to Version 2
Version 2 of the Cirrus Ping Auth Module introduces some API changes.

The user information was formerly stored in the session as `req.session.jwt`. This information is now available as `req.session.passport.user`. Here is some example code:

_old version (v1.2.7)_
```js
app.use((req, res, next) => {
  console.log(`UserID: ${req.session.jwt.sub}`);
  console.log(`Access token: ${res.session.jwt.access_token}`);
  next();
})
```

_new version (v2.0.1)_
```js
app.use((req, res, next) => {
  const user = req.session.passport.user;
  console.log(`UserID: ${user.sub}`);
  console.log(`Access token: ${user.access_token}`);
  next();
})
```

The OpenID issuer can be configured by setting the `OPENID_ISSUER` environment variable. The default is `https://federate-qa.xh1.lilly.com`. You will need to update this if you are running in dev or prod environments.


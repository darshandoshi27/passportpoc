# Cirrus Authentication Release Summary 

---
## Revision History

1. Please see the version(s) section for current and previous versions. 
2. Please see the commit name for the reason for review.
3. Please see the author of the commit to see who the change was revised by.
4. Please see the date of the commit to see the revision date. 


## Reviewers

Every time a revision occurs, one user must review the changes before the approval occur. The following people have reviewed the document. 

| Printed Name | Job Title           |
|--------------|---------------------|
| Chris Dieter | IT Analyst |

## Approvals

Every time a revision occurs, a pull request will be created, between the branch where the revisions have been made, and the master branch where the master document lives. The following people have to sign off on the changes made.

| Printed Name          | Signature               | Title            | Date                    | Signature Meaning                                                                                                                                                                                                                                                                                                                                                                     |
|-----------------------|-------------------------|------------------|-------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Christos Konstantinou | See GitHub Pull Request | System Custodian | See GitHub Pull Request | Your signature indicates that the appropriate persons involved in the validation process have reviewed this document to ensure that the strategy is adequate to properly validate the computer system.You understand your responsibility to provide resources necessary to validate the system as described in the strategy, and you understand your role in the validation process. |
| Nick Liffen       | See GitHub Pull Request | System Owner     | See GitHub Pull Request | Your signature indicates that the appropriate persons involved in the validation process have reviewed this document to ensure that the strategy is adequate to properly validate the computer system.You understand your responsibility to provide resources necessary to validate the system as described in the strategy, and you understand your role in the validation process. |
| Sherman Altick        | See GitHub Pull Request | CSQA             | See GitHub Pull Request | Your signature means that this Security Plan complies with the relevant Lilly Quality Practices                                                                                                                                                                                                       

---
## Document Introduction
 
This document provides Test Summary and Release information for the Cirrus Authentication module, in addition to other validation deliverables and activities that are unique to this accelerator.
Publication of this document and accelerator code to GitHub indicates that the accelerator is in a validated state and ready for consumption.
The [Cirrus Accelerator Validation Strategy document](https://github.com/EliLillyCo/cirrus-documentation) in GitHub is a parent of this document and provides the Validation Plan, Test Plan and other key validation deliverables that are common across all accelerators.
 
## Release Identification 
 
| Key                 	| Value                       	|
|---------------------	|-----------------------------	|
| Accelerator Name    	| Cirrus Authentication Module 	|
| ServiceNow CMDB CI: 	| CI00000000380980, CI00000000380975|
| Version Number      	| 1.0.0                         |


## Requirements/User Stories. 
| User Story | URL                                                               |
|------------|-------------------------------------------------------------------|
| US-1       | https://github.com/EliLillyCo/CIRR_Authorization_Service/issues/1 |
| US-2       | https://github.com/EliLillyCo/CIRR_Authorization_Service/issues/2 |
| US-3       | https://github.com/EliLillyCo/CIRR_Authorization_Service/issues/3 |

## Accelerator Overview & Design

### Overview.

This module provides the ability to authenticate a user against Lilly Single Sign On (SSO). Installing and configuring this module will bring SSO to your application(s). There are two different authentication flows as part of this module:

1. **OpenID Implicit Flow (Pre-Production Flow)**: This module should be used for applications that simply need single sign on, with no need to know more about the user who is authenticating. This module will protect the application with SSO authentication, but will only return the user's System ID. For applications in Heroku, this flow should be used for: Review, Development and Staging applications. This module should not be used for production applications. The advantage of this module is it's fully self service and autonomous, no service request needs to made. Applications can have single factor or multi factor authentication.
2. **OpenID Connect Flow (Production Flow)**: This module should be used for application that need single sign on (sso), but also a need to know **more** about a user. For example, interacting with the Lilly Gateway and Workforce SAD. This authentication flow will return an access token which then can be used to interact with other Lilly services. For applications in Heroku, this flow should be used for: Review, Development, Staging and Production applications. Applications can have single factor or multi factor authentication. Using this authentication module requires the application team to create a service request into the federation team. The SLA for that is 2 days. 

The way that the user picks which authentication flow the application uses is via a environment variable. 


### Design. 

**Overall**

This module was designed in a modular fashion, so in total there are *three* different modules. There is the *parent* module called: `cirrus-auth-module` which pulls in two separate children modules called: `cirrus-ping-auth-module` & `cirrus-openid-auth-module`. Application teams can either `npm install` the parent module which provides all functionality, or the individual child modules. The module was designed in this way to give flexibility based on application team requirements. For example, an application team may want to use the pre-production module for review and development applications to bring the ability to authenticate review applications, but use the production authentication flow for staging and production applications to be able to interact with the gateway and Workforce SAD. Whereas another application may not want to authenticate review applications, so may use the production authentication flow across all applications. 

**OpenID Implicit Flow (Pre-Production Flow)**

1. The pre-production flow was designed to give application teams the autonomous ability to apply SSO to their application. 
2. It was designed to authenticate against Ping Federate (QA), hence the reason why the module shouldn't be used in production. 
3. This module only uses a Client ID to interact with Ping, there is no client secret used.
4. This module does not return an access token, it returns a JWT Token, with the only user information returned within the JWT is the authenticated users System ID.  
5. Client ID's are based off on application naming conventions. For each functional area within Lilly there is a different Client ID. Example. Meaning the redirect URL's are a wild-carded. For example, GIS: **https://gis-*.herokuapp.com** has a clentID of: 34**56. Whereas **https://buit-*.herokuapp.com** has a clentID of: 12**98. 

**OpenID Connect Flow (Production Flow)**

1. The production flow was designed to give application teams the ability to apply single sign on (sso), but also return an access token which can be interacted with other Lilly services. 
2. It was designed that application teams have the ability to connect to Ping Federate (Dev, QA & PROD). Users can specify the environments they need in the ServiceNow request. 
3. This module only uses a Client ID and a Client Secret to interact with Ping. 
4. This module does return an access token which is within the JWT token returned from Ping. The only user information returned within the JWT is the authenticated users System ID. To get more information about a user, the access token needs to be used to interact with the Workforce SAD. 

## Test Steps

All documentation for the below can be found on one of the below links, dependent on the module:

1. [Cirrus Auth Module](https://github.com/EliLillyCo/CIRR_AUTH_MODULE)
2. [Cirrus Pre-Production Auth Flow](https://github.com/EliLillyCo/CIRR_PING_AUTH_MODULE)
3. [Cirrus Production Auth Flow](https://github.com/EliLillyCo/CIRR_OIDC_AUTH_MODULE)

The majority of the documentation can be found in the [Cirrus Auth Module](https://github.com/EliLillyCo/CIRR_AUTH_MODULE).

### 1. **OpenID Implicit Flow (Pre-Production Flow)**

#### Test 1.1 - Installing the module

_Test scenario:_

As an end user, I need to be able to install the module into my code. 

_Expected Result:_

User is able to install the module. The module was in the `node_modules` folder.

_Actual Result:_

User was able to install the module by creating a `.npmrc`in the root of there directory and included:

```javascript
registry=https://npm-proxy.fury.io/C4a7337WDFSKV4waL6CL/h_app58363299/
ca=
```

This file points the application to the repository where all custom modules are held. After this file was in place the user decided to install the parent module by running:

```javascript
npm install cirrus-auth-module --save
```

This installed the `cirrus-auth-module` in the `node_modules` folder.

#### Test 1.2 - Collecting Client ID

_Test scenario:_

As an end user, I need to be able to locate the client ID which is used to interact with Ping Federate (QA). The client ID re-direct URL must match the name of what my application is called. 

_Expected Result:_

The end user should be able to locate their client id based on the name of their application.

_Actual Result:_

User was able to navigate to [Auth Standards](https://cirr-heroku-auth-standards.herokuapp.com/) where the Client ID's are located. User was successfully able to find the Client ID which matched the application URL. 

#### Test 1.3 - Environment Variables 

_Test scenario:_

As an end user, I need to be able to locate the environment variables which need to be put into the Heroku configuration variables & local `.env` file.

_Expected Result:_

The end user should be able to locate the relevant environment variables. 

_Actual Result:_

User was able to navigate to [Cirrus Ping Authentication Flow](https://github.com/EliLillyCo/CIRR_PING_AUTH_MODULE#configuration-instructions) where the environment variables. User was successfully able to put them into Heroku. 

#### Test 1.4 - Code Configuration 

_Test scenario:_

As an end user, I need to be able to know what code needs to be included into the application to make the authentication work. 

_Expected Result:_

The user can find the relevant code, and then include it without running into any errors. 

_Actual Result:_

User was able to navigate to [Cirrus Ping Authentication Flow](https://github.com/EliLillyCo/CIRR_PING_AUTH_MODULE#features) where the code snippet can be found on what's needed. 

```javascript
const auth = require('cirrus-auth-module');
auth.authenticate(app);
```

#### Test 1.5 - Authentication (Review, Development & Staging Applications)

_Test scenario:_

As an end user, after getting the correct ID, putting in the environment variables and then putting the right code snippets in, the application should authenticate with Single Sign On (SSO). Not only should this work with development and staging applications, this should also work with review applications. Meaning it isn't URL specific. 

_Expected Result:_

All applications within the Heroku Pipeline with the correct environment variables should be authenticated with SSO. 

_Actual Result:_

Application(s) successfully authenticated. 


#### Test 1.6 - Multi-Factor Authentication

_Test scenario:_

As an end user, I want to be able to apply multi-factor authentication to my application using this authentication flow. There should be appropriate documentation which shows how to configure this. 

_Expected Result:_

User can find the relevant documentation and apply multi-factor authentication. 

_Actual Result:_

Application(s) successfully authenticated with multi-factor authentication by changing the scope from `openid auth_web` to `openid auth_webmfa`


### 2. **OpenID Implicit Flow (Production Flow)**

#### Test 2.1 - Installing the module

_Test scenario:_

As an end user, I need to be able to install the module into my code. 

_Expected Result:_

User is able to install the module. The module was in the `node_modules` folder.

_Actual Result:_

User was able to install the module by creating a `.npmrc`in the root of there directory and included:

```javascript
registry=https://npm-proxy.fury.io/C4a7337WDFSKV4waL6CL/h_app58363299/
ca=
```

This file points the application to the repository where all custom modules are held. After this file was in place the user decided to install the parent module by running:

```javascript
npm install cirrus-auth-module --save
```

This installed the `cirrus-auth-module` in the `node_modules` folder.

### Test 2.2 - Raising the service request to Ping Federate

_Test scenario:_

As an end user, I need to be able to raise a request to the Ping Federate team to get a Client ID & Client Secret which allow my application to be authenticated with Ping Federate. 

_Expected Result:_

User is able to follow the documentation and raise a request to the Ping team will the correct details. The federation team returns a valid Client ID & Client Secret. 

_Actual Result:_

User was able to follow the relevant documentation [here](https://github.com/EliLillyCo/CIRR_OIDC_AUTH_MODULE#cirrus-open-id-connect-authentication-flow) raising a successful request to the Ping Federate team. It took 3 days for the Ping team to return the Client ID and Client Secret. User used information provided in ping number 2) under Configuration Instructions to find out how to submit the request. This was the information which the user specified in the request:

**Application Name**: Lilly Developer Portal
**Request Action**: Create new vendor hosted federation (application hosted by third party)
**Specify Vendor Name**: Heroku
**Primary contact**: Nick Liffen
**Secondary contact**: Christos 
**Director contact appropriate to the project**: Mike Henry
**Requested implementation date:** 08/12/2017
**Additional Information**: request that the connection include the scopes `auth_web auth_webmfa`, and `openid`. The callback's for this project is: , https://cirr-lpld-dev-stg.herokuapp.com, https://cirr-lpld.herokuapp.com

The Ping Team sent the user the Client ID & Client Secret. 

### Test 2.2 - Setting up environment variables 

_Test scenario:_

As an end user, I need to be able to find the relevant environment variables to put within the Heroku configuration variables. 

_Expected Result:_

User is able to find environment variable and successfully puts them in Heroku. 

_Actual Result:_

User was able to navigate to [here](https://github.com/EliLillyCo/CIRR_OIDC_AUTH_MODULE#cirrus-open-id-connect-authentication-flow) and find the relevant variables to enter. The user's specific environment variables were: 

**AUTH_TYPE**=openid
**OPENID_CALLBACK**=/auth/callback
**OPENID_ISSUER**=https://federate-qa.xh1.lilly.com
**OPENID_TOKEN_URL**=https://federate-qa.xh1.lilly.com/as/token.oauth2
**OPENID_USER_INFO_URL**=https://federate-qa.xh1.lilly.com/idp/userinfo.openid
**AUTH_REQUIRED**=true
**DISABLE_AUTH_LOGS**=false
**COOKIE_SECRET**=htu74%^^lsQ12:
**OPENID_NONCE**=34kfj3$5
**OPENID_CLIENT_ID**=*provided by Ping Team*
**OPENID_CLIENT_SECRET**=*provided by Ping Team*

#### Test 1.4 - Code Configuration 

_Test scenario:_

As an end user, I need to be able to know what code needs to be included into the application to make the authentication work. 

_Expected Result:_

The user can find the relevant code, and then include it without running into any errors. 

_Actual Result:_

User was able to navigate to [here](https://github.com/EliLillyCo/CIRR_AUTH_MODULE#quick-start) where the code snippet can be found on what's needed. 

```javascript
const auth = require('cirrus-auth-module');
auth.authenticate(app);
```

#### Test 1.5 - Application Authentication

_Test scenario:_

As an end user, now all the environment variables, code snippets and service requests have been raised, the next step is to test the application(s) to see if the authentication has worked. 

The authentication is going to be tested on all the applications that were submitted as part of the service request. In this case the URL's which are going to be tested are as followed: https://cirr-lpld-dev-stg.herokuapp.com, https://cirr-lpld.herokuapp.com

_Expected Result:_

The above applications are now authenticated with Lilly single sign on (sso)

_Actual Result:_

Application(s) successfully authenticated. 

#### Test 1.6 - Multi-Factor Authentication

_Test scenario:_

As an end user, I want to be able to apply multi-factor authentication to my application using this authentication flow. There should be appropriate documentation which shows how to configure this. 

_Expected Result:_

User can find the relevant documentation and apply multi-factor authentication. 

_Actual Result:_

Application(s) successfully authenticated with multi-factor authentication by changing the scope from `openid auth_web` to `openid auth_webmfa`

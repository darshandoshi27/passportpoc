
> cirrus-oidc-auth-module@4.0.6 test /home/jenkins/workspace/rus-oidc-auth-module_v4.0.6-BW2R4QKLA7EDPDXPQH3UEFNUNVCFT4KOORRAFVJET47H4OATV6PQ
> gulp build && nyc npx mocha --timeout=3000

[04:29:52] Using gulpfile ~/workspace/rus-oidc-auth-module_v4.0.6-BW2R4QKLA7EDPDXPQH3UEFNUNVCFT4KOORRAFVJET47H4OATV6PQ/gulpfile.js
[04:29:52] Starting 'build'...
[04:29:54] Finished 'build' after 2.32 s
[AUTH] Using OPENID_ISSUER https://login.microsoftonline.com/18a59a81-eea8-4c30-948a-d8824cdc2580/v2.0
[AUTH] Using openid-connect auth v4.0.6


  Logging framework
    logs when logging is enabled
[AUTH] test log.error
      ✓ should be able to log with .error
[AUTH] test log.warn
      ✓ should be able to log with .warn
[AUTH] test log.success
      ✓ should be able to log with .success
[AUTH] test log.info
      ✓ should be able to log with .info
[AUTH] test log.plain
      ✓ should be able to log with .plain
    no log when logging is disabled
[AUTH] : Logs are disabled.
      ✓ should not log with .error
      ✓ should not log with .warn
      ✓ should not log with .success
      ✓ should not log with .info
      ✓ should not log with .plain

  createSessionOpts
    saveUninitialized
      ✓ should set a default saveUninitialized if not present
      ✓ should allow the user to configure saveUninitialized
    resave
      ✓ should set a default resave if not present
      ✓ should allow the user to configure resave
    secret
      ✓ should set a default secret if not present
      ✓ should allow the user to configure secret
    name
      ✓ should set a default name if not present
      ✓ should allow the user to configure name
    cookie.httpOnly
      ✓ should set a default cookie.httpOnly if not present
      ✓ should allow the user to configure cookie.httpOnly
    cookie.maxAge
      ✓ should set a default cookie.maxAge if not present
      ✓ should allow the user to configure cookie.maxAge
    cookie.path
      ✓ should set a default cookie.path if not present
      ✓ should allow the user to configure cookie.path
    cookie.sameSite
      ✓ should set a default cookie.sameSite if not present
      ✓ should allow the user to configure cookie.sameSite
    cookie.secure
      ✓ should set a default cookie.secure if not present
      ✓ should allow the user to configure cookie.secure
    proxy
      ✓ should set a default proxy if not present
      ✓ should allow the user to configure proxy
    rolling
      ✓ should set a default rolling if not present
      ✓ should allow the user to configure rolling
    unset
      ✓ should set a default unset if not present
      ✓ should allow the user to configure unset

  Cirrus Auth Module
    #authenticate
      ✓ should exist
[AUTH] Could not discover OpenID issuer, retrying...
[AUTH] Discovered issuer: https://login.microsoftonline.com/18a59a81-eea8-4c30-948a-d8824cdc2580/v2.0
      ✓ should add middleware to express (72ms)
    #ignore
[AUTH] The following routes are ignored: 
[AUTH] test one two
      ✓ should accept an array as a parameter
[AUTH] The following routes are ignored: 
[AUTH] test one two foo bar baz
      ✓ should accept multiple parameters
    #authMiddleware
[AUTH] The following routes are ignored: 
[AUTH] test one two foo bar baz /ignored
[AUTH] Serving /ignored to verified user
      ✓ should invoke next() if path is in ignored routes
      ✓ should not redirect an authenticated user
      ✓ should redirect an unauthenticated user to the login page
[AUTH] refresh token found! original_token
[AUTH] Refresh flow invoked
[AUTH] Refresh token get. Applying to session
      ✓ should invoke the refresh flow if cookie is set to expire
[AUTH] refresh token found! original_token
      ✓ should not invoke the refresh flow if cookie is not set to expire
[AUTH] refresh token found! original_token
[AUTH] Refresh flow invoked
[AUTH] Could not refresh token. Destroying session.
      ✓ should destroy session and re-auth the user if their token cannot be refreshed
[AUTH] refresh token found! original_token
[AUTH] Refresh flow invoked
[AUTH] Could not refresh token. Destroying session.
      ✓ should respond with 403 for bad tokens if the client doesn't support text/html
    /auth/userid
[AUTH] Serving /auth/userid
[AUTH] userid: no-authenticated-user
      ✓ should respond with json (49ms)
    /login
[AUTH] Serving /login
      ✓ should redirect user to federation server
[AUTH] Serving /auth/callback
[AUTH] User has been authenticated: C000000
      ✓ should save user details to the session store (62ms)
    /logout
[AUTH] Serving /login
[AUTH] Serving /logout
      ✓ should log out user and redirect to correct url


  49 passing (347ms)

----------------|----------|----------|----------|----------|-------------------|
File            |  % Stmts | % Branch |  % Funcs |  % Lines | Uncovered Line #s |
----------------|----------|----------|----------|----------|-------------------|
All files       |    83.33 |    82.83 |    88.89 |    84.09 |                   |
 auth.js        |    80.62 |    76.81 |       88 |     81.1 |... 41,243,244,270 |
 logger.js      |      100 |      100 |      100 |      100 |                   |
 openid-vars.js |      100 |      100 |      100 |      100 |                   |
 sessions.js    |    85.71 |    95.83 |       80 |    87.88 |       15,16,22,58 |
----------------|----------|----------|----------|----------|-------------------|

# Cirrus OIDC Auth Module
> Express middleware to enable SSO using the Open ID Connect protocol with Lilly's standard provider, Azure AD

## Table of Contents
* [Introduction](#intrduction)
* [Prerequisites](#prerequisites)
* [Installation](#installation)
* [Environment Variables](#environment-variables)
* [Usage](#usage)
* [Contributing](#contributing)
* [Interaction with the Gateway](#interaction-with-the-gateway)
* [Setting Express up for HTTPS](#setting-express-up-for-https)
* [Migrating to Version 4](#migrating-to-version-4)

## Introduction
This module provides [Open ID Connect (OIDC) 1.0](https://openid.net/connect/) protocol support for the Cirrus Authentication Module. It is integrated into the hybrid authentication module, found [here](https://github.com/EliLillyCo/CIRR_AUTH_MODULE).  OIDC is built on top of the [OAuth 2.0](https://oauth.net/2/) protocol for authorization.  This module also helps manage access tokens received after successful SSO, which your app can use for authentication when calling Lilly REST APIs.

## Prerequisites

### Express.js
You will need to be using Express as your web framework. This module provides middleware for express, and thus will not work for other node web frameworks.

### Redis
You will need Redis to be running in the background. This can be done (on a \*nix machine) with `redis-server --daemonize yes`. If you have provisioned Redis server on Heroku, this will already be done for you. 

Please ensure that your redis version is >2.6.

### .npmrc
To install this module, you need access to the gemfury repository. To get access to this, you need a .npmrc file in the root of your project's directory. The file should look like this:

```ini
registry = https://elilillyco.jfrog.io/elilillyco/api/npm/Lilly-NPM/
_auth = YXJ0aWZhY3RvcnlAbGlzdHMubGlsbHkuY29tOkFLQ3A1YkIzY3hrdkVGRmlYQUtSU2lQZjFyV0dKV0JIZDllcHoxcEtDSlk4WWNjcDhyb2J6dm52OXV0VjhYNXN3TGFrUlY1d1A=
always-auth = true
email = artifactory@lists.lilly.com
```

### Federation Connection
To use this module, you will need to request a 'federation connection'.  This will register your app in Lilly Azure AD for OIDC.

**Filling out the Federation Connection Request:**

1. Request a new federation connection by submitting a service request to the Federation Services team. The service request is [here](https://lilly.service-now.com/ess/view_content_search.do?v=1&uri=com.glideapp.servicecatalog_cat_item_view.do%3Fv%3D1%26sysparm_id%3De2c504b00fbbf10028ed6509b1050e22%26sysparm_link_parent%3D47932b7135e7340014379b119de070df%26sysparm_catalog%3De0d08b13c3330100c8b837659bba8fb4&sysparm_document_key=sc_cat_item,e2c504b00fbbf10028ed6509b1050e22)

2. Complete the form in its entirety.  For the purposes of using this module, the important values are:
   - **Select an action to be performed:**  Create a new federation connection
   - **Select the federation protocol:** OpenID Connect (OIDC) 1.0/OAuth 2.0
   - **Provide connection technical information:**
     * Request the connection include any of the following scopes your app might need:
       * `openid` - enable the OIDC protocol for SSO
       * `email` - include `email` attribute in the ID token's claims
       * `profile` - include `name`, `preferred_username` (Lilly Active Directory User Principal Name (UPN)), `uid` (Lilly system ID), and `employee_id` (Lilly global ID) attributes in the ID token's claims
       * If your app will call Lilly REST APIs:
         * `offline_access` - provide refresh tokens, which are used to auto-renew access tokens before they expire
         * One of the following:
           * `api://29cd31e5-0ac5-441c-b435-7ea0c8709dde/.default` - for non-production apps/APIs
           * `api://39b64b04-e385-4232-a4e2-604367e2d849/.default` - for production apps/APIs
     * Request that the callback URL be set to https://&lt;your heroku-app-name&gt;.herokuapp.com/auth/callback (default) or https://&lt;your custom Lilly domain hostname&gt;&lt;your custom OPENID_CALLBACK value&gt; (e.g. https://example.lilly.com/some/callback/endpoint)
       * You can provide multiple URLs here.  For example, you could have one federation connection for all your non-prod app URLs (e.g. dev, tst, QA), and one for all your prod app URLs (e.g. stg, uat, prod).
       * For non-prod, also include http://localhost if you'll test your app locally

If you would like to see an example, please see the following request: [RITM1435512](https://lilly.service-now.com/ess/sc_req_item.do?sys_id=79b60a9a13e7030c0961bbc76144b057&sysparm_stack=&sysparm_view=)

## Installation

`npm install cirrus-oidc-auth-module` or `yarn add cirrus-oidc-auth-module`.

It is recommended that you use this module via the [hybrid module](https://github.com/EliLillyCo/CIRR_AUTH_MODULE).

## Environment Variables

| Environment Variable         | Required? | Default Value                                                                   |
| ---------------------------- | --------- | ------------------------------------------------------------------------------- |
| `OPENID_CLIENT_ID`           | **Yes**   | None. Recieved from Federation team after fulfilling your ServiceNow request    |
| `OPENID_CLIENT_SECRET`       | **Yes**   | None. Recieved from Federation team after fulfilling your ServiceNow request    |
| `REDIS_URL`                  | **Yes**   | None. Provided by Heroku (locally it should be `redis://localhost:6379`)        |
| `REDIS_SECRET`               | **Yes**   | None. Provide a secret with which to encrypt your Redis sessions                |
| `AUTH_ENABLED`               | **Yes**   | `false` **set to true when auth is needed**                                     |
| `AUTH_TYPE`                  | **Yes**   | `openid-connect`                                                                |
| `OPENID_SCOPE`               | **Yes**   | `openid` <sup>1</sup>                                         |
| `OPENID_ISSUER`              | No        | `https://login.microsoftonline.com/18a59a81-eea8-4c30-948a-d8824cdc2580/v2.0` <sup>2</sup>                                              |
| `USERID_ENDPOINT`            | No        | `/auth/userid`                                                                  |
| `OPENID_CALLBACK`            | No        | `/auth/callback`                                                                |
| `ENABLE_AUTH_LOGGING`        | No        | `false`                                                                         |
| `COOKIE_SECRET`              | No        | `uuid()` (generated at runtime) <sup>3</sup>                                    |
| `REDIS_PASSWORD`             | No        | Null.                                                                           |
| `REFRESH_WINDOW`             | No        | `300`. This many seconds before the access token expires, the module will attempt to obtain a new access token using the refresh token. |
| `SESSION_SAVE_UNINITIALIZED` | No        | `false` <sup>4</sup>                                                            |
| `SESSION_RESAVE`             | No        | `false` <sup>4</sup>                                                            |
| `SESSION_COOKIE_NAME`        | No        | `lilly.id` <sup>4</sup>                                                         |
| `SESSION_COOKIE_HTTP_ONLY`   | No        | `true` <sup>4</sup>                                                             |
| `SESSION_COOKIE_MAX_AGE`     | No        | `1800000` <sup>4</sup>                                                          |
| `SESSION_COOKIE_PATH`        | No        | `/` <sup>4</sup>                                                                |
| `SESSION_COOKIE_SAME_SITE`   | No        | `undefined` <sup>4</sup>                                                        |
| `SESSION_COOKIE_SECURE`      | No        | `undefined` <sup>4</sup>                                                        |
| `SESSION_PROXY`              | No        | `undefined` <sup>4</sup>                                                        |
| `SESSION_ROLLING`            | No        | `false` <sup>4</sup>                                                            |
| `SESSION_UNSET`              | No        | `keep` <sup>4</sup>                                                             |

1. If you asked for additional scopes in your federation connection request, set this value to a space-delimited list of these scopes.  Example: `oidc email profile offline_access api://29cd31e5-0ac5-441c-b435-7ea0c8709dde/.default`
2. This is Lilly production Azure AD.  Both production and non-production apps are registered here.
3. **WARNING: running multiple web dynos!** If your app runs multiple Heroku web dynos, you *must* specify your own value for COOKIE_SECRET.  If you let the value be auto-generated (the default), each dyno will have a different value and your users will lose their web sessions while they are using your app.
4. These are all options used to initialize the `express-session` module. You can find further documentation about these options [in their GitHub repo here](https://github.com/expressjs/session).

## Usage

```js
import * as auth from 'cirrus-oidc-auth-module';
import express from 'express';

auth.authenticate(app);

/** other express middleware goes here **/
...
/* */

// if you want to access routes without authenticating (webhooks, files for a web worker)
auth.ignore(['/api/contentful/hook', '/public/bundle.js']);

app.listen(5000, () => console.log('Listening on port 5000'));
```

## Contributing 

1. Clone this repository:
```zsh
git clone https://github.com/EliLillyCo/CIRR_OIDC_AUTH_MODULE.git
```

2. Create a new branch with a descriptive name matching the issue:

```zsh
git checkout master
git checkout -b feature/123-issue-description-here
```

3. If this is a change in functionality, add a unit test that fails without that new functionality.

4. Make necessary code changes.

5. Run linting scripts:
```zsh
npm run lint
```

6. Run unit tests. Make sure that your new test is passing:
```zsh
npm run test
```

7. Update the version number in `package.json` and `package-lock.json` and update the `CHANGELOG.md` file with your changes. This project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html) so keep that in mind when assigning your version number.

8. Push your branch to GitHub and open a pull request.

9. Wait for continuous integration tests to pass (will appear as a comment in the pull request).

10. Wait for feedback. You will need two approving reviews before your code is allowed to be merged with the master branch.

## Calling APIs published in a Lilly API Gateway

[Cirrus Gateway Service](https://github.com/EliLillyCo/CIRR_Gateway_Service) module will help your app authenticate to Lilly REST APIs using the access token.

## Support
[Recommended] Lodge an issue on the [issue tracker](https://github.com/EliLillyCo/CIRR_PING_AUTH_MODULE/issues?q=is%3Aissue+is%3Aopen+sort%3Aupdated-desc) with information on your issue and steps to reproduce.

If you need direct assistance, submit a [Cirrus Consulting Request](https://lilly.service-now.com/com.glideapp.servicecatalog_cat_item_view.do?v=1&sysparm_id=cf195392dbe49f006b3f7d71ba961971) with a description of the problem you're experiencing, and the operations team will return a response.

## Refresh Tokens

Access tokens from Azure AD expire after 30 minutes. When a refresh token is available (by including `offline_access` in `OPENID_SCOPE`) it is stored in a user's session within the auth module. 

When the access token has `REFRESH_WINDOW` (default 300) seconds to live, the auth module will make a background request using the refresh token to obtain a new access token and a new refresh token. This continues to extend the session 30 minutes at a time, up to a maximum of 8 hours, before the user has to re-authenticate by going through the OIDC SSO flow again.

## Setting Express up for HTTPS
This is recommended for local development using authentication.

1. Sign some certificates:
```zsh
openssl genrsa -out server-key.pem 1024
openssl req -new -key server-key.pem -out server-csr.pem
openssl x509 -req -in server-csr.pem -signkey server-key.pem -out server-cert.pem
```

2. Pull HTTPS in to your Express app
```js
/**
 * Pull in main requirements
 */
import express from 'express';
import https from 'https';
import http from 'http';
import fs from 'fs';

// we have to use 'import * as' because there is no default export in auth
import * as auth from 'cirrus-auth-module';

const app = express();

/**
 * Load keys from local files
 */

const key = fs.readFileSync('server-key.pem');
const cert = fs.readFileSync('server-cert.pem');
const options = { key, cert };
app.set('port', process.env.PORT || 5000);

auth.authenticate(app);

app.use('/', express.static(__dirname + '/public'));

let server;

/**
 * If we're developing locally, use https
 * If we're not, we're on heroku which we can use HTTPS for.
 */
if (process.env.NODE_ENV === 'local') {
  server = https.createServer(options, app);
} else {
  server = http.createServer(app);
}   

// listen and let us know when we're good to go!
server.listen(process.env.PORT);
server.on('listening', () => console.log(`Server listening on localhost:${process.env.PORT}`));
```

## Migrating to Version 4

Version 4 introduces Azure AD support (Lilly's new OIDC provider) and retires explicit PingFederate support.  As of Q4 2019, all new federation connections are fulfilled using Azure AD.  By the end of 2020, all existing PingFederate federation connections will be migrated to new Azure AD federation connections.  When migrating an existing app from PingFederate to Azure AD:
* Upgrade the module version to v4.x (`npm upgrade cirrus-oidc-auth-module`)
* Update `OPENID_CLIENT_ID` and `OPENID_CLIENT_SECRET` with the new values from Azure AD, provided by the Federation team
* Delete `PING_VERSION` config var, if any (no longer used)
* Delete `OPENID_ISSUER` config var, if any, to take the default (Lilly Azure AD)
* Delete `OPENID_SCOPE` config var, if any, to take the default `oidc`, or update it to include scopes for additional user attributes, getting refresh tokens, and/or calling APIs (e.g. `openid email profile offline_access api://29cd31e5-0ac5-441c-b435-7ea0c8709dde/.default`)
* In your app code:
  * Replace all references to `req.session.passport.user.sub` or `req.session.passport.user.claims.sub` with `req.session.passport.user.claims.uid`
  * Replace all references to `req.session.passport.user.userinfo` with `req.session.passport.user.claims`


## Migrating to Version 3
(**NOTE:** This is legacy information for historical purposes only.)

As of v3.1.2, the 3.x branch supports Node 10 and Node 12 ðŸ˜„ Previous versions of the 3.x branch only supported Node 12. We recommend all developers use the 3.x branch going forward, as it will receive dependency updates, bugfixes, and security fixes.


## Migrating to Version 2
(**NOTE:** This is legacy information for historical purposes only.)

Version 2 of the Cirrus OIDC Auth Module introduces some API changes.

The user information was formerly stored in the session as `req.session.jwt`. This information is now available as `req.session.passport.user`. Here is some example code:

_old version (v1.2.1)_
```js
app.use((req, res, next) => {
  console.log(`UserID: ${req.session.jwt.sub}`);
  console.log(`Access token: ${res.session.jwt.access_token}`);
  next();
})
```

_new version (v2.2.0)_
```js
app.use((req, res, next) => {
  const user = req.session.passport.user;
  console.log(`UserID: ${user.sub}`);
  console.log(`Access token: ${user.access_token}`);
  next();
})
```

Additionally, there are changes to the configuration of environment variables that are needed:
* `AUTH_ENABLED` is now required. This was previously defaulted to false, but that could easily mislead a user into thinking their application is being secured by authentication when it isn't.
* `REDIS_SECRET` is now required. This is a key that Redis will use to encrypt the sessions stored in it.
* `COOKIE_SECRET` is a new configuration variable. This will allow you to choose the key used to encrypt the cookie data. If left blank it will be randomly generated when the server starts. If your application is running across multiple nodes you will need to set this variable to ensure consistency.

The OpenID issuer can be configured via two methods. You can set a url to a specific value by setting the `OPENID_ISSUER` environment variable. Or you can set `PING_VERSION` to `DEV` or `PROD` to choose the dev or prod federate servers, respectively. The default if both of these values are unset is `https://federate-qa.xh1.lilly.com`.

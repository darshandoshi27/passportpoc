export default (options) => {
  if (typeof options === 'string') {
    options = { redirectTo: options };
  }
  options = options || {};

  const url = options.redirectTo || '/login';
  const setReturnTo = (options.setReturnTo === undefined)
    ? true
    : options.setReturnTo;

  return (req, res, next) => {
    if (!req.isAuthenticated || !req.isAuthenticated()) {
      if (setReturnTo && req.session) {
        req.session.returnTo = req.originalUrl || req.url;
        if (req.session.save && typeof req.session.save === 'function') {
          return req.session.save(() => {
            res.redirect(url);
          });
        }
      }
      return res.redirect(url);
    }
    return next();
  };
};
